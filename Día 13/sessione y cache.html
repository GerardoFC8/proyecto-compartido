<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gu√≠a Completa de Sesiones y Cach√© en Laravel 12</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Fira+Code&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slightly darker background */
            color: #1a202c;
        }
        code:not(.language-bash):not(.language-php) {
            font-family: 'Fira Code', monospace;
        }
        .prose h2, .prose h3 {
            scroll-margin-top: 2rem;
        }
        .prose h2 {
            border-bottom-width: 2px;
            border-color: #e2e8f0;
            padding-bottom: 0.5rem;
        }
        .sidebar-link {
            @apply block py-2 px-3 rounded-md text-slate-700 hover:bg-slate-200 hover:text-slate-900 transition-colors;
        }
        /* Estilos para los bloques de c√≥digo */
        .prose pre {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 1.25rem 1.5rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .prose pre code {
            color: inherit;
            background-color: transparent;
            padding: 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body class="bg-slate-100">

    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar -->
        <nav class="md:w-72 bg-white p-4 md:p-6 shadow-lg md:fixed md:h-screen">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Navegaci√≥n</h2>
            <ul class="space-y-2">
                <li><strong class="text-slate-500 text-sm uppercase">Sesiones</strong></li>
                <li><a href="#sessions" class="sidebar-link">Introducci√≥n a Sesiones</a></li>
                <li><a href="#sessions-usage" class="sidebar-link">Uso B√°sico de Sesiones</a></li>
                <li><a href="#session-table" class="sidebar-link">La Tabla `sessions`</a></li>
                <li><a href="#sessions-advanced" class="sidebar-link">Temas Avanzados de Sesi√≥n</a></li>

                <li><strong class="text-slate-500 text-sm uppercase mt-4 block">Cach√©</strong></li>
                <li><a href="#cache" class="sidebar-link">Introducci√≥n a Cach√©</a></li>
                <li><a href="#cache-remember" class="sidebar-link">Uso de <code>Cache::remember()</code></a></li>
                <li><a href="#cache-table" class="sidebar-link">La Tabla `cache`</a></li>
                <li><a href="#cache-advanced" class="sidebar-link">Temas Avanzados de Cach√©</a></li>

                <li><strong class="text-slate-500 text-sm uppercase mt-4 block">Herramientas</strong></li>
                <li><a href="#tinker" class="sidebar-link">Laravel Tinker</a></li>
                <li><a href="#tinker-usage" class="sidebar-link">Tinker para Cach√© y Sesiones</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 md:ml-72 p-4 sm:p-8">
            <header class="text-center mb-10">
                <h1 class="text-4xl font-bold text-slate-800">Gu√≠a Completa de Sesiones y Cach√© en Laravel 12 üöÄ</h1>
            </header>

            <!-- Sessions Module -->
            <div class="bg-white rounded-xl shadow-lg p-8 mb-10">
                <div class="prose prose-lg max-w-none">
                    <section id="sessions">
                        <h2 class="text-3xl font-bold">Cap√≠tulo 1: Las Sesiones - Recordando a tus Usuarios</h2>
                        <p>Imagina que visitas una tienda online. A√±ades un producto a tu carrito, navegas a otra p√°gina y... ¬°el producto sigue ah√≠! ¬øC√≥mo es posible si HTTP es un protocolo "sin estado" (stateless)? La respuesta es: <strong>magia de sesi√≥n</strong>.</p>
                        <div class="p-4 my-6 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded-r-lg">
                            <strong class="font-bold">Analog√≠a del mundo real:</strong> Piensa en una sesi√≥n como un gafete que te dan al entrar a un evento. El gafete tiene un n√∫mero √∫nico (el ID de sesi√≥n). Los organizadores tienen una lista que asocia tu n√∫mero con tu nombre (los datos de la sesi√≥n). Mientras lleves el gafete, sabr√°n qui√©n eres.
                        </div>
                    </section>
                    
                    <section id="sessions-usage" class="mt-12">
                        <h3>¬øC√≥mo se usan las Sesiones en Laravel?</h3>
                        <p>Laravel proporciona una API muy sencilla. Puedes acceder a la sesi√≥n a trav√©s del helper global <code>session()</code> o inyectando la clase <code>Illuminate\Http\Request</code>.</p>
                        <h4>Guardar y Obtener datos:</h4>
                        <pre><code class="language-php">// Guardar datos
session(['clave' => 'valor']);
request()->session()->put('nombre_usuario', 'Alex');

// Obtener datos (con un valor por defecto opcional)
$valor = session('clave', 'valor_por_defecto');
$nombre = request()->session()->get('nombre_usuario');</code></pre>
                        <div class="p-6 my-8 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50">
                            <h3 class="mt-0">¬°Vamos a probarlo!</h3>
                            <p>Haz clic en los botones para simular c√≥mo se guardan y recuperan datos de una sesi√≥n del lado del servidor.</p>
                            <div class="flex flex-wrap gap-4">
                                <button onclick="guardarEnSesion()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar Nombre de Usuario</button>
                                <button onclick="leerDeSesion()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Leer Nombre de Usuario</button>
                                <button onclick="olvidarSesion()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Olvidar Nombre</button>
                            </div>
                            <div id="session-output" class="mt-4 p-4 bg-slate-200 rounded-lg font-mono text-sm">El estado de la sesi√≥n aparecer√° aqu√≠.</div>
                        </div>
                    </section>

                    <section id="session-table" class="mt-12">
                        <h3>La Tabla `sessions` en la Base de Datos</h3>
                        <p>Cuando usas el driver `database`, Laravel almacena la informaci√≥n en la tabla <code>sessions</code>. Para crearla, ejecuta:</p>
                        <pre><code class="language-bash">php artisan session:table
php artisan migrate</code></pre>
                        <h4>¬øQu√© es el `payload`?</h4>
                        <p>Es la columna m√°s importante. Contiene <strong>todos los datos de la sesi√≥n</strong>. Laravel toma estos datos, los <strong>serializa</strong> (convierte el array a un string) y los codifica en <strong>Base64</strong> para guardarlos de forma segura en la base de datos.</p>
                    </section>

                    <section id="sessions-advanced" class="mt-12">
                        <h3>Temas Avanzados de Sesi√≥n</h3>
                        <h4>Drivers de Sesi√≥n</h4>
                        <p>Adem√°s de `database`, Laravel soporta otros drivers configurables en <code>.env</code> (<code>SESSION_DRIVER</code>):</p>
                        <ul>
                            <li><code>file</code>: (Por defecto) Guarda las sesiones en archivos en <code>storage/framework/sessions</code>. Simple, pero no escala bien en sistemas con m√∫ltiples servidores.</li>
                            <li><code>cookie</code>: Guarda toda la sesi√≥n encriptada en la cookie del cliente. √ötil para aplicaciones peque√±as, pero tiene un l√≠mite de tama√±o (4KB).</li>
                            <li><code>redis</code> / <code>memcached</code>: Almacenan las sesiones en memoria. Son extremadamente r√°pidos y la opci√≥n preferida para aplicaciones de alto rendimiento.</li>
                        </ul>
                        <h4>Bloqueo de Sesiones (Session Blocking)</h4>
                        <p>Por defecto, Laravel "bloquea" el archivo o registro de sesi√≥n mientras un script se est√° ejecutando. Si un usuario abre dos pesta√±as y hace dos peticiones lentas a la vez, la segunda petici√≥n esperar√° a que la primera termine. Para evitar esto en rutas que no modifican la sesi√≥n, puedes desactivar el bloqueo:</p>
                        <pre><code class="language-php">// En routes/web.php
Route::get('/reporte-lento', [ReportController::class, 'generar'])
    ->block(false);</code></pre>
                    </section>
                </div>
            </div>

            <!-- Cache Module -->
            <div class="bg-white rounded-xl shadow-lg p-8 mb-10">
                <div class="prose prose-lg max-w-none">
                    <section id="cache">
                        <h2 class="text-3xl font-bold">Cap√≠tulo 2: La Cach√© - Acelerando tu Aplicaci√≥n</h2>
                        <p>Imagina una consulta a la base de datos que es muy pesada, tarda 5 segundos y los datos que devuelve rara vez cambian. ¬øSer√≠a eficiente ejecutarla cada vez? ¬°Claro que no! Aqu√≠ es donde entra la <strong>cach√©</strong>.</p>
                    </section>

                    <section id="cache-remember" class="mt-12">
                        <h3>El m√©todo que lo cambia todo: <code>Cache::remember()</code></h3>
                        <p>La forma m√°s poderosa de usar la cach√© es con <code>remember</code>. Su l√≥gica es brillante:</p>
                        <ol>
                            <li>¬øExiste el dato 'mi-clave' en la cach√©?</li>
                            <li><strong>Si existe:</strong> Devu√©lvelo inmediatamente. ‚úÖ</li>
                            <li><strong>Si no existe:</strong> Ejecuta el c√≥digo, guarda el resultado en cach√© por el tiempo especificado, y luego devu√©lvelo. üíæ</li>
                        </ol>
                        <pre><code class="language-php">use Illuminate\Support\Facades\Cache;

$usuarios = Cache::remember('todos_los_usuarios', now()->addMinutes(60), function () {
    // Este c√≥digo S√ìLO se ejecuta si el dato no est√° en cach√©.
    return User::all();
});</code></pre>
                        <div class="p-6 my-8 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50">
                            <h3 class="mt-0">¬°Simulador de Cach√©!</h3>
                            <p>Este simulador imita c√≥mo funciona <code>Cache::remember</code>. La primera vez que pidas los datos, habr√° un "retraso". Las veces siguientes, ser√° instant√°neo.</p>
                            <div class="flex flex-wrap gap-4">
                                <button onclick="obtenerDatosPesados()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Obtener Datos Pesados</button>
                                <button onclick="limpiarCache()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Limpiar Cach√© de Datos</button>
                            </div>
                            <div id="cache-output" class="mt-4 p-4 bg-slate-200 rounded-lg font-mono text-sm">El resultado aparecer√° aqu√≠.</div>
                        </div>
                    </section>
                    
                    <section id="cache-table" class="mt-12">
                        <h3>La Tabla `cache` en la Base de Datos</h3>
                        <p>Si usas el driver `database`, necesitar√°s la tabla <code>cache</code> (y <code>cache_locks</code>). Se crean con:</p>
                        <pre><code class="language-bash">php artisan cache:table
php artisan migrate</code></pre>
                    </section>

                    <section id="cache-advanced" class="mt-12">
                        <h3>Temas Avanzados de Cach√©</h3>
                        <h4>Etiquetas de Cach√© (Cache Tags)</h4>
                        <p>Son incre√≠blemente √∫tiles para invalidar m√∫ltiples elementos de cach√© relacionados a la vez. Imagina que guardas en cach√© los posts de varios usuarios. Si un usuario actualiza su nombre, ¬øc√≥mo invalidas toda su informaci√≥n en cach√©? Con etiquetas.</p>
                        <pre><code class="language-php">// Almacenar datos con etiquetas
Cache::tags(['usuario:1', 'posts'])->remember('posts_usuario_1', 3600, function() {
    return Post::where('user_id', 1)->get();
});

Cache::tags(['usuario:1', 'perfil'])->remember('perfil_usuario_1', 3600, function() {
    return User::find(1);
});

// Ahora, para limpiar toda la cach√© del usuario 1 de una vez:
Cache::tags(['usuario:1'])->flush(); // ¬°Magia!
</code></pre>
                        <p class="text-sm text-slate-600">Nota: Los drivers <code>file</code> y <code>database</code> no soportan etiquetas. Necesitar√°s usar <code>redis</code> o <code>memcached</code>.</p>
                    </section>
                </div>
            </div>

            <!-- Tinker Module -->
            <div class="bg-white rounded-xl shadow-lg p-8 mb-10">
                <div class="prose prose-lg max-w-none">
                    <section id="tinker">
                        <h2 class="text-3xl font-bold">Cap√≠tulo 3: Laravel Tinker - Tu Navaja Suiza</h2>
                        <p><code>php artisan tinker</code> es una de las herramientas m√°s poderosas de Laravel. Es una consola interactiva (REPL) que carga tu aplicaci√≥n completa, permiti√©ndote ejecutar cualquier c√≥digo de Laravel directamente desde la terminal.</p>
                        <h3>¬øPara qu√© sirve exactamente?</h3>
                        <ul>
                            <li><strong>Probar L√≥gica R√°pidamente:</strong> Ejecutar c√≥digo sin necesidad de crear rutas o controladores.</li>
                            <li><strong>Manipular Datos:</strong> Crear, leer o actualizar modelos de Eloquent. Ej: <code>App\Models\User::find(1)->update(['name' => 'Nuevo Nombre']);</code></li>
                            <li><strong>Disparar Eventos o Jobs:</strong> Probar la funcionalidad de colas y eventos de forma manual.</li>
                            <li><strong>Interactuar con la Cach√©:</strong> Como veremos a continuaci√≥n, es perfecto para gestionar la cach√©.</li>
                        </ul>
                    </section>

                    <section id="tinker-usage" class="mt-12">
                        <h3>Tinker para Cach√© y Sesiones</h3>
                        <h4>Manejando la Cach√© con Tinker</h4>
                        <p>Puedes usar el facade <code>Cache</code> en Tinker como lo har√≠as en tu c√≥digo. Es ideal para depurar o para poblar la cach√© manualmente.</p>
                        <pre><code class="language-bash">php artisan tinker
Psy Shell v0.11.8 (PHP 8.2.4 ‚Äî cli) by Justin Hileman
>>> use Illuminate\Support\Facades\Cache;

>>> // Guardar algo en cach√© por 60 segundos
>>> Cache::put('saludo_desde_tinker', '¬°Hola Mundo!', 60);
=> true

>>> // Recuperar el valor
>>> Cache::get('saludo_desde_tinker');
=> "¬°Hola Mundo!"

>>> // Comprobar si existe
>>> Cache::has('saludo_desde_tinker');
=> true

>>> // Olvidar la clave
>>> Cache::forget('saludo_desde_tinker');
=> true

>>> Cache::get('saludo_desde_tinker');
=> null
</code></pre>
                        <h4>¬øY qu√© hay de las Sesiones?</h4>
                        <p>Aqu√≠ hay un matiz importante: <strong>el helper <code>session()</code> no funciona en Tinker</strong>. Una sesi√≥n est√° inherentemente ligada a una petici√≥n HTTP (un navegador visitando tu web). Como Tinker es un entorno de consola, no existe tal petici√≥n.</p>
                        <p>Sin embargo, si usas el driver de base de datos, ¬°puedes "ver" las sesiones activas consultando la tabla directamente! Esto es √∫til para depuraci√≥n.</p>
                        <pre><code class="language-bash">>>> use Illuminate\Support\Facades\DB;

>>> // Ver el primer registro de sesi√≥n en la base de datos
>>> DB::table('sessions')->first();
=> {#4768
     +"id": "aBcDeFgHiJkLmNoPqRsTuVwXyZ12345",
     +"user_id": 1,
     +"ip_address": "127.0.0.1",
     +"user_agent": "Mozilla/5.0 (Macintosh; ...)",
     +"payload": "YTozOntzOjY6Il90b2tlbiI7czo0MDoi...", // <-- ¬°Ah√≠ est√°n los datos!
     +"last_activity": 1679344853,
   }
</code></pre>
                        <h5 class="mt-6 font-bold">Decodificando un `payload` de Sesi√≥n en Tinker</h5>
                        <p>Una vez que tienes el string del `payload`, puedes decodificarlo f√°cilmente en Tinker para ver exactamente qu√© datos contiene la sesi√≥n. El proceso tiene dos pasos: primero decodificar de Base64 y luego deserializar.</p>
                        <pre><code class="language-bash">>>> // 1. Obt√©n el payload de una sesi√≥n
>>> $payload = DB::table('sessions')->where('user_id', 1)->first()->payload;

>>> // 2. Decodif√≠calo de Base64
>>> $decoded = base64_decode($payload);
=> "a:4:{s:6:"_token";s:40:"...";s:9:"_previous";a:1:{s:3:"url";s:31:"http://localhost/example";...}"

>>> // 3. Deserial√≠zalo para verlo como un array de PHP
>>> $data = unserialize($decoded);
=> [
     "_token" => "long_random_string_here",
     "_previous" => [
       "url" => "http://localhost/example",
     ],
     "_flash" => [
       "old" => [],
       "new" => [],
     ],
     "login_web_59ba36addc2b2f9401580f014c7f58ea4e30989d" => 1,
   ]
</code></pre>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Simulaci√≥n de Sesi√≥n ---
        let sessionData = {};
        const sessionOutput = document.getElementById('session-output');

        function guardarEnSesion() {
            sessionData['nombre_usuario'] = 'MariaDB';
            sessionOutput.innerHTML = `<span class="text-blue-600">GUARDADO:</span> Se ha guardado el nombre '<strong>${sessionData['nombre_usuario']}</strong>' en la sesi√≥n.`;
        }

        function leerDeSesion() {
            const nombre = sessionData['nombre_usuario'] || '<em class="text-slate-500">no hay nombre guardado</em>';
            sessionOutput.innerHTML = `<span class="text-green-600">LE√çDO:</span> Nombre recuperado de la sesi√≥n: <strong>${nombre}</strong>`;
        }

        function olvidarSesion() {
            delete sessionData['nombre_usuario'];
            sessionOutput.innerHTML = `<span class="text-red-600">BORRADO:</span> El nombre de usuario ha sido eliminado de la sesi√≥n.`;
        }

        // --- Simulaci√≥n de Cach√© ---
        let cacheData = {};
        const cacheOutput = document.getElementById('cache-output');

        function obtenerDatosPesados() {
            cacheOutput.innerHTML = 'Consultando datos... ü§î';

            if (cacheData['datos_pesados']) {
                 setTimeout(() => {
                    cacheOutput.innerHTML = `<strong>(Desde CACH√â)</strong> ‚úÖ Datos recuperados instant√°neamente: <br><em>${cacheData['datos_pesados']}</em>`;
                }, 100);
            } else {
                 cacheOutput.innerHTML = 'Calculando datos por primera vez (operaci√≥n lenta)... ‚è≥';
                 setTimeout(() => {
                    const datos = 'Resultado de una consulta muy compleja - ' + new Date().toLocaleTimeString();
                    cacheData['datos_pesados'] = datos;
                    cacheOutput.innerHTML = `<strong>(Desde la FUENTE ORIGINAL)</strong> üíæ Datos generados y guardados en cach√©: <br><em>${datos}</em>`;
                }, 2000);
            }
        }
        
        function limpiarCache() {
             delete cacheData['datos_pesados'];
             cacheOutput.innerHTML = `<span class="text-red-600">LIMPIADO:</span> La cach√© de 'datos_pesados' ha sido eliminada. La pr√≥xima petici√≥n ser√° lenta.`;
        }
    </script>
</body>
</html>